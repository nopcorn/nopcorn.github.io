<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Using DuckDuckGoâ€™s Image Proxy as a C2 Channel" /><meta name="author" content="nopcorn" /><meta property="og:locale" content="en_US" /><meta name="description" content="DuckDuckGoâ€™s image preview APIs put way too much trust in the user and donâ€™t validate that the requests came from authentic browsing behavior." /><meta property="og:description" content="DuckDuckGoâ€™s image preview APIs put way too much trust in the user and donâ€™t validate that the requests came from authentic browsing behavior." /><link rel="canonical" href="http://0.0.0.0:4000/2023/09/25/duckduckgo-as-c2" /><meta property="og:url" content="http://0.0.0.0:4000/2023/09/25/duckduckgo-as-c2" /><meta property="og:site_name" content="nopcorn" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-09-25T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Using DuckDuckGoâ€™s Image Proxy as a C2 Channel" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"nopcorn"},"dateModified":"2023-09-25T00:00:00+00:00","datePublished":"2023-09-25T00:00:00+00:00","description":"DuckDuckGoâ€™s image preview APIs put way too much trust in the user and donâ€™t validate that the requests came from authentic browsing behavior.","headline":"Using DuckDuckGoâ€™s Image Proxy as a C2 Channel","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/2023/09/25/duckduckgo-as-c2"},"url":"http://0.0.0.0:4000/2023/09/25/duckduckgo-as-c2"}</script><title> Using DuckDuckGo&#39;s Image Proxy as a C2 Channel - nopcorn</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="nopcorn" href="/atom.xml"><link rel="alternate" type="application/json" title="nopcorn" href="http://0.0.0.0:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}hr{background:#dfdfdf !important;margin-top:1rem;margin-bottom:1rem}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin-bottom:1rem}code,pre{background:#ecedee}code{padding:.1rem;padding-left:.3rem;padding-right:.3rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{background-color:#eee;padding:1rem;margin-top:1rem;margin-bottom:1rem;border-left:5px solid #ddd}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section{margin-top:.45rem}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:.5rem}.posts ul,header ul{list-style:none}blockquote ul{margin-left:1rem}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}.post ul,.project ul,.post ol{list-style-position:inside}main{display:flex;flex-wrap:wrap;max-width:70rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:.5rem}#logo{width:5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}@media print{.no-print,.no-print *{display:none !important}}code{font-size:.75rem;vertical-align:text-bottom}blockquote code{background:#fff}pre code{display:inline-block}pre{white-space:pre-wrap}#logo{border-radius:50% !important}pre:has(>.language-hack-nowrap){white-space:pre}#topnav{margin-top:1rem}.social-icons{width:2.5rem}blockquote ul,blockquote ol{list-style-position:unset !important}</style></head><body><main><header aria-hidden="true" class="no-print"> <a href="/"> <!--<h1 class="logo" style="margin-top:0;font-family:monospace">\x90corn</h1>--> <img id="logo" src="/assets/logo.jpeg"/> </a><nav id="topnav" role="navigation" aria-hidden="true"><ul><li><a href="/" >posts</a></li><li><a href="/about" >about</a></li><li><a href="/atom.xml" >rss</a></li></ul></nav></header><section class="post"><h2>Using DuckDuckGo's Image Proxy as a C2 Channel</h2><span class="meta"><time datetime="2023-09-25T00:00:00+00:00">September 25, 2023</time> &middot; <a href="/tag/infrastructure">infrastructure</a>, <a href="/tag/c2">c2</a>, <a href="/tag/proxy">proxy</a></span><blockquote><ul><li>DuckDuckGoâ€™s image proxy doesnâ€™t allow-list trusted URLs, so anyone can request any image through it.</li><li>The proxy doesnâ€™t sanitize the URI, allowing for any number of request parameters to be relayed to the server hosting the image.</li><li>This can be leveraged by a malicious actor to covertly communicate with a compromised server using an image-based protocol.</li><li>Small proof of concept provided: <a href="https://github.com/nopcorn/DuckDuckC2">DuckDuckC2</a></li></ul></blockquote><p><a href="https://duckduckgo.com">DuckDuckGo</a> (DDG) is a search engine known for its emphasis on user privacy. Unlike many other search engines, it doesnâ€™t track usersâ€™ search history, ensuring a more private online search experience. With its user-friendly interface and commitment to not collecting or sharing personal information, it has garnered a dedicated user base among privacy-conscious individuals.</p><h1 id="expected-behavior">Expected Behavior</h1><p>Conducting an image search via DuckDuckGo results in many requests to the <code>external-content</code> subdomain:</p><p><img src="/assets/img/ddg-image-search-network-loads.png" alt="" /></p><p>This endpoint seems to accept a url as parameter <code>u</code> and returns and image. From some of the research Iâ€™ve been conducting on image proxies, I know this domain as Bingâ€™s own image proxy (<code>tse.mm.bing.net</code> and <code>tse.explicit.bing.net</code>). Itâ€™s not surprising that DuckDuckGo would be leveraging Bingâ€™s services as they <a href="https://duckduckgo.com/duckduckgo-help-pages/results/sources/">source traditional links and images in their search results from the company</a>. Scrolling down through multiple pages of image search always shows the same domains being supplied in the <code>u</code> parameter.</p><p>I assumed the <code>external-content</code> proxy would only be allow-listing <code>*.bing.net</code> domains and decided it would be interesting to try and confuse the regular expression that was underpinning this function by registering custom domains with <code>bing</code> substrings. Keeping things simple though, I first tested for the presence of the allow-listing by generating a webhook on my testing server and providing it to the proxyâ€¦</p><p>..and it happily tried to pull the image ðŸ¤¦</p><h1 id="probing-the-api">Probing the API</h1><p>To my surprise, DuckDuckGo happily accepted the webhook and requested it to receive content. I guess they arenâ€™t allow-listing domains. The request my server received looked like this - curiously, the IP it came from doesnâ€™t appear in <a href="https://duckduckgo.com/duckduckgo-help-pages/results/duckduckbot/">DuckDuckGoâ€™s list of DuckDuckBot IPs</a>, despite providing the <code>DuckDuckBot/1.1</code> user-agent:</p><pre><code>GET /notanimage HTTP/1.1
Host: &lt;MYSERVER&gt;
Accept: */*
connection: close
accept-encoding: gzip
user-agent: DuckDuckBot/1.1; (+http://duckduckgo.com/duckduckbot.html)
</code></pre><p>Probing the <code>/iu</code> endpoint a bit more, I discovered that DuckDuckGo returns a <code>HTTP/2 400</code> error if the content isnâ€™t understood by the proxy (aka it isnâ€™t an image in a valid format - likely based on <code>Content-Type</code> headers). Alternative HTTP verbs like <code>POST</code> and <code>PUT</code> get automatically converted by DuckDuckGoâ€™s servers to a <code>GET</code> for the same endpoint. We know the server software is likely <code>nginx</code> based on the banner, so itâ€™s possible the location block for the <code>/iu</code> endpoint looks something like this:</p><pre><code>location @force_get {
    proxy_method GET;
    proxy_pass_request_headers off;
    proxy_pass http://ourupstream;
}
</code></pre><p>The proxy <em>does</em> pass request parameters to the server hosting the image. I fuzzed the maximum parameter size and it doesnâ€™t seem like DuckDuckGo is performing any filtering on content or length. This means that the only limit is from the web servers and clients doing the proxying. I was able to relay 8192 bytes of data without issue and suspect that number isnâ€™t the ceiling. Additionally, it seems like multiple DuckDuckGo subdomains support the <code>/iu</code> proxy service.</p><h1 id="using-as-a-c2-channel">Using as a C2 Channel</h1><p>Assuming we control both sides of proxy connection, we can communicate using request parameters and return output via encoded images using the proper <code>Content-Type</code> headers. While this can be leveraged in many ways, hereâ€™s how my proof of concept <a href="https://github.com/nopcorn/DuckDuckC2">DuckDuckC2</a> works:</p><p><img src="/assets/img/duckduckc2-flow.png" alt="" /></p><p>It assumes that <code>server.py</code> is running somewhere where a shell is desired and that <code>client.py</code> needs to communicate with it from reputable IP space (DuckDuckGo). The client can relay tasking for the server via GET parameters and the output the commands are encoded into the image returned as a result. DuckDuckGo happily forwards on the modified image and the client is able to extract the output from it. All of this functionality is wrapped is a pseudo-shell to give the client the impression they are interacting with an actual shell.</p><h1 id="remediation">Remediation</h1><p>Without internal knowledge of DuckDuckGoâ€™s strategy for image search, itâ€™s difficult to say if this open proxy is a bug or pre-positioning code for integration with future image providers. I would suggest applying an allow-list of domains to the API underpinning this feature - likely something like <code>*.bing.net</code> would suffice as it seems all legitimate use of the proxy simply points to Bing. DuckDuckGo does have many other products though, so itâ€™s possible there are other uses in other codebases.</p><p>Defending against the use of this technique in a network isnâ€™t too difficult seeing as most web servers will log request parameters. Regardless of the directionality (whether the client or server is in your network), attackers will have to go to great lengths to obfuscate commands and responses from network-aware security solutions.</p></section></main><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "8156489757ba4337bde96df7a40dcc1b"}'></script></body></html>
